#!/bin/sh

# Shortcut sysupgrade from a sysupgraded machine to upgrade another machine on LAN
# Use ONLY after:
#	(a) successfully doing sysupgrade on the local machine
#	(b) If the remote is pre-6.5, you should really do a full manual
#		upgrade; if not possible, be sure you've upgraded boot blocks to 6.5+
#		(update installboot and /usr/mdec, then run installboot)
# Don't run under doas because you dont want to ssh as root.
# Lightly tested on i386 and amd64 - use at own risk!

[ -w / ] && {
	echo Do not run $0 as root
	exit
}

case $# in
	0)	echo "Usage: $0 host [...]" >&2
		exit 1;;
esac

LOCAL_ARCH=$(arch)

for HOST
do

	set -e
	REMOTE_ARCH=$(ssh ${HOST} arch)
	if [ ${LOCAL_ARCH} != "${REMOTE_ARCH}" ]; then
		echo "This machine is ${LOCAL_ARCH} but ${HOST} is ${REMOTE_ARCH}" >&2
		exit 1;
	fi

	D=/home/_sysupgrade


	ssh ${HOST} "doas mkdir -p ${D}; doas chmod g+w ${D}"

	scp ${D}/* ${HOST}:${D}

	set +e # reboot will fail ssh

	ssh ${HOST} doas "cp ${D}/bsd.rd /bsd.upgrade && doas reboot"

done
