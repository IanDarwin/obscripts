#!/bin/sh

# rl - reload various system servers' data
# $Id$

PROGNAME=$0; export PROGNAME

function reload_by_pid {
	serv=$1
	if [ -f /var/run/$serv?pid ]; then
		kill -HUP `sed -e 1q /var/run/$serv?pid`
	else
		echo >&2 "Sorry, $PROGNAME doesn't know how to reload $serv ."
	fi
}

function do_help {
	echo "$0 reloads servers. Services available include:"
	echo "nat pf `cd /var/run; ls *.pid|sed 's/\.pid//g' `"
}

function do_arp {
	ETHERS=/etc/ethers
	# format is: 08:00:20:04:e3:f0       dartboard
	cat ${ETHERS} | while read ether_addr hostname
	do
		arp -s ${hostname} ${ether_addr} temp
	done
}

function interface {
		zap -y dhclient
		dhclient $1
}

serv=$1
	case $serv in
	-h|-help)
		do_help
		exit
		;;
	arp)
		do_arp
		;;
	dc*)
		interface dc0
		;;
	gem*)
		interface gem0
		;;
	named|bind)
		named.reload
		sleep 1
		echo "Now please check this logfile..."
		watchlog daemon
		;;
	nat|pf|ip)
		# enable, in case this is first time.
		pfctl -e >/dev/null 2>&1
		# flush old data
		pfctl -F all
		# reload NAT data
		pfctl -f /etc/pf.conf
		;;
	http*|apache)
		if [ -x /usr/sbin/apachectl ]; then
			apachectl restart
		else
			if [ -f /var/www/logs/httpd.pid ]; then
				kill -HUP `cat /var/www/logs/httpd.pid`
			else
				echo "Can't find either apachectl or httpd.pid, sorry"
			fi;
		fi
		;;
	nfs)
		reload_by_pid mountd
		;;
	postfix)
		postfix reload
		;;
	pf)
		pfctl -R /etc/pf.conf
		;;
	sendmail)
		reload_by_pid sendmail
		;;
	tomcat)
		unset CLASSPATH
		export CATALINA_HOME=/usr/local/jakarta-tomcat-4.1.0/
		export JAVA_HOME=/usr/local/java
		cd ${CATALINA_HOME}
		bin/catalina.sh stop
		bin/catalina.sh start
		;;
	wi*)
		interface wi0
		;;
	*)
		# must be a regular daemon
		reload_by_pid $serv
		;;
	esac

