#!/bin/ksh

# rl - reload various system servers' data
# $Id$

PROGNAME=$0; export PROGNAME

function reload_by_pid {
	serv=$1
	if [ -f /var/run/$serv?pid ]; then
		kill -HUP `sed -e 1q /var/run/$serv?pid`
	else
		echo >&2 "Sorry, $PROGNAME doesn't know how to reload $serv ."
	fi
}

function do_help {
	echo "$0 reloads servers. Services available include:"
	echo "pf `cd /var/run; ls *.pid|sed 's/\.pid//g' `"
}

function do_arp {
	ETHERS=/etc/ethers
	# format is: 08:00:20:04:e3:f0       dartboard
	cat ${ETHERS} | while read ether_addr hostname
	do
		arp -s ${hostname} ${ether_addr} temp
	done
}

USAGE="$0 [-i][-v] service"

function usage {		# give usage message, and exit
	echo "Usage: $USAGE" 2>&1
	exit 1
}

while getopts "hiv" opt 
do 
 	 case "$opt" in 
		h)	do_help
			exit
			;;
		i)	INTERACT=YES;;
		v)	VERBOSE=-v;;
		*)	usage;;
	esac
done
shift `expr $OPTIND - 1`		 # leave just filenames

for serv
do
	case $serv in
	help)
		do_help
		exit
		;;
	*[01])					# rl0, sis0, ath0, etc.
		sh /etc/netstart ${serv}
		;;
	arp)
		do_arp
		;;
	dhcpd)
		pkill dhcpd
		. /etc/rc.conf.local
		/usr/sbin/dhcpd ${dhcpd_flags}
		;;
	asterisk)
		asterisk -rx reload
		ps -ax | grep >/dev/null asterisk || sudo /usr/local/sbin/asterisk >/tmp/asterisk.log &
		;;
	ipsec)
		kill -HUP `cat /var/run/isakmpd.pid`
		ipsecctl -f /etc/ipsec.conf
		;;
	jabber*)
		pkill "perl -w -x /usr/local/sbin/jabberd"
		/usr/local/sbin/jabberd </dev/null &
		;;
	named|bind)
		#rndc reload
		rndc stop
		named -t /var/named

		sleep 1
		echo "Now please check this logfile..."
		watchlog -n25 daemon
		;;
	nagios)
		# N.B. Invoke in check mode before pkilling old and starting new.
		sudo -u _nagios nagios -v /etc/nagios/nagios.cfg && {
			pkill nagios
			sudo -u _nagios nagios -d /etc/nagios/nagios.cfg
		}
		;;
	http*|apache)
		if [ -x /usr/sbin/apachectl ]; then
			apachectl restart
		else
			if [ -f /var/www/logs/httpd.pid ]; then
				kill -HUP `cat /var/www/logs/httpd.pid`
			else
				echo "Can't find either apachectl or httpd.pid, sorry"
			fi;
		fi
		;;
	nfs)
		reload_by_pid mountd
		;;
	openvpn|vpn)
		pkill openvpn
		grep "/usr/local/sbin/openvpn --" /etc/rc.local | sh -x
		;;
	postfix)
		postfix reload
		;;
	postgres*)
		# /usr/local/bin/pg_ctl restart -D /var/postgresql/data
		cd /var/postgresql
		if [ -f /var/postgresql/data/postmaster.pid ]; then
			sudo -u _postgresql /usr/local/bin/pg_ctl  reload -D /var/postgresql/data
		else
			sudo -u _postgresql nohup /usr/local/bin/pg_ctl start \
			    -D /var/postgresql/data -l /var/postgresql/logfile \
			    -o '-D /var/postgresql/data' # >/dev/null
		fi
		;;
	pf)
		pfctl -e /etc/pf.conf 2>/dev/null
		pfctl -f /etc/pf.conf
		;;
	ppp*)
		pkill -9 pppd
		sleep 1
		sudo pppd call sympatico
		;;
	sendmail)
		reload_by_pid sendmail
		;;
	smtpd)
		pkill smtpd
		/usr/sbin/smtpd
		;;
	spam*)
		# reload spamd
		/usr/libexec/spamd-setup -d -D
		;;
	squid)
		pkill -TERM squid
		sleep 1
		pkill -9 squid
		/usr/local/sbin/squid
		;;
	tomcat)
		unset CLASSPATH
		case `uname` in
		Darwin)	export CATALINA_HOME=~/tomcat;;
		*)		export CATALINA_HOME=/usr/local/tomcat/
				export JAVA_HOME=/usr/local/java
				;;
		esac
		cd ${CATALINA_HOME}
		bin/catalina.sh stop
		sleep 5				# takes a while
		mv ${CATALINA_HOME}/logs/catalina.{out,bak} 2>/dev/null
		case ${INTERACT} in
			YES) cmd=run;;
			""|*) cmd=start;;
		esac
		bin/catalina.sh ${cmd}
		;;
	*)
		# must be a regular daemon
		reload_by_pid $serv
		;;
	esac
done
