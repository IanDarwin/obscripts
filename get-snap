#!/bin/sh -u

# get the current OpenBSD snapshot
# XXX after committing, rename to obget (no longer just snaps)

REL=37					# "37" for OpenBSD 3.7, etc.
RELEASEDIR=3.7			# As above but with "."
SNAPDIR="snapshots"		# XXX derive from REL
EXT=.tgz

TODIR=OpenBSD

SITE=ftp1.ca.openbsd.org		# where to get it from
FROMDIR=pub/OpenBSD
ARCH=`uname -m`

prog=ftp			# how to get it, XXX add option to change to scp 
PROTO=ftp			# how $PROG is to get it, change to e.g http
VERBOSE=""			# how chattily to get it

# Where to put it
if [ -d ~ftp/pub ]; then
	BASEDIR=~ftp/pub/${TODIR}		# where to put it locally
elif [ -d ~/download ]; then
	BASEDIR=~/download/${TODIR}
else
	echo "No download directory found" >&2
	exit 1
fi


USAGE="$0 [-s][-a arch ][-b local-Basedir][ -f host]
-a arch := i386|sparc|hppa|...
-v -- Verbose
"

function usage {		# give usage message, and exit
	echo "Usage: $USAGE" 2>&1
	exit 1
}

while getopts "a:b:f:hsvx" opt 
do 
 	 case "$opt" in 
		a)	ARCH=$OPTARG ;;
		b)	BASEDIR=$OPTARG ;;
		f)	
			case "$OPTARG" in
			dos) SITE=ftp.darwinsys.com;;
			ob|sunsite) SITE=ftp.openbsd.org;;
			rtfm) SITE=rt.fm;;
			*)		SITE=${OPTARG};;
			esac
			;;
		h)	PROTO=http;;
		s)	SNAPDIR="${RELEASEDIR}"
			echo "****************************************************"
			echo "$0: -s means to NOT use snapshot, using ${RELEASEDIR}"
			echo "****************************************************"
			echo -n "OK? "; read answer
			;;
		v)	VERBOSE=v;;
		x)	NO-X=YES;;
		*)	usage;;
	esac
done
shift `expr $OPTIND - 1`		 # leave just filenames

# Where to download it to
DIR=${BASEDIR}/${SNAPDIR}/${ARCH}
if [ ! -d ${DIR} ]; then
	mkdir -p ${DIR}
fi
cd ${DIR} || exit

FILES="MD5 index.txt INSTALL.${ARCH} bsd bsd.rd bsd.mp base${REL}${EXT} cd${REL}.iso etc${REL}${EXT} misc${REL}${EXT} comp${REL}${EXT} game${REL}${EXT} man${REL}${EXT}"
XFILES="xbase${REL}${EXT} xetc${REL}${EXT}  xfont${REL}${EXT} xserver${REL}${EXT} xshare${REL}${EXT}"

case ${ARCH} in
	amd64)	FILES="$FILES floppy${REL}.fs";;
	i386)	FILES="$FILES floppy${REL}.fs floppyB${REL}.fs";;
	macppc)	FILES="$FILES bsd.tbxi";;
	sparc*)	FILES="$FILES floppy${REL}.fs miniroot${REL}.fs";;
esac

if [ "" != "NO-X" ]; then
	FILES="$FILES $XFILES"
fi

if [ "" != "${VERBOSE}" ]; then
	set -x
fi

if [ $# -ne 0 ]; then
	usage
fi

case ${prog} in
ftp)
	for f in ${FILES}
	do
		CMD="ftp ${PROTO}://${SITE}/${FROMDIR}/${SNAPDIR}/${ARCH}/${f}"
		echo "--> $CMD"
		$CMD
	done
	;;
ssh)
	scp -r ian@${SITE}:~ftp/${PREFIX}/${TOP}/${ARCH}/ .
	;;
esac
